name: Setup for First Inoculation - Substrate App Workflow
author: Casey Stone
info: Workflow for preparing decks for first OT-2 inoculations
version: '0.1'


flowdef:
  # start with plate with lid on exchange

  # remove the lid to lid nest 3
  - name: remove lid from plate on exchange
    module: biopf400
    action: remove_lid
    args:
      source: exchange_deck_low_narrow
      target: lidnest_3_narrow
      source_approach: safe_path_exchange
      target_approach: safe_path_lidnest_3
      source_plate_rotation: narrow
      target_plate_rotation: narrow
      lid_height: 8

  # transfer into OT-2 deck 1
  - name: pf400 transfer
    module: biopf400
    action: transfer
    args:
      source: exchange_deck_high_wide
      target: payload.ot2_location
      source_approach: safe_path_exchange
      target_approach: payload.ot2_safe_path
      source_plate_rotation: wide
      target_plate_rotation: wide
    comment: Transfer new substrate plate from exchange to OT-2

  # run OT-2 inoculation protocol
  - name: Run OT-2 protocol
    module: ot2biobeta
    action: run_protocol
    args:
      use_existing_resources: False
    files:
      protocol: payload.current_ot2_protocol
    comment: Run the current OT-2 protocol

  # open BMG tray
  - name: Open the BMG plate reader tray
    module: bio_bmg
    action: open

  # transfer plate from ot2 to exchange
  - name: Transfer plate without lid to exchange location
    module: biopf400
    action: transfer
    args:
      source: payload.ot2_location
      target: exchange_deck_high_wide
      source_approach: payload.ot2_safe_path
      target_approach: safe_path_exchange
      source_plate_rotation: wide
      target_plate_rotation: wide

  # transfer plate without lid to bmg nest
  - name: Transfer plate without lid to bmg nest
    module: biopf400
    action: transfer
    args:
      source: exchange_deck_low_narrow
      target: bmg_reader_nest
      source_approach: safe_path_exchange
      target_approach: safe_path_bmg
      source_plate_rotation: narrow
      target_plate_rotation: narrow

  # close BMG tray
  - name: Close the BMG reader tray
    module: bio_bmg
    action: close

  # open BMG tray
  - name: Open the BMG plate reader tray
    module: bio_bmg
    action: open

  # transfer from BMG to exchange
  - name: Transfer plate without lid from bmg to exchange
    module: biopf400
    action: transfer
    args:
      source: bmg_reader_nest
      target: exchange_deck_low_narrow
      source_approach: safe_path_bmg
      target_approach: safe_path_exchange
      source_plate_rotation: narrow
      target_plate_rotation: narrow

  # replace the lid
  - name: replace lid
    module: biopf400
    action: replace_lid
    args:
      source: lidnest_3_narrow
      target: exchange_deck_low_narrow
      source_approach: safe_path_lidnest_3
      target_approach: safe_path_exchange
      source_plate_rotation: narrow
      target_plate_rotation: narrow
      lid_height: 8

  # open incubator
  - name: open incubator
    module: inheco_devID2_floor0
    action: open

  # transfer from exchange to incubator
  - name: transfer
    module: biopf400
    action: transfer
    args:
      source: exchange_deck_low_narrow
      target: payload.incubator_location
      source_approach: safe_path_exchange
      target_approach: safe_path_inheco_dev2
      source_plate_rotation: narrow
      target_plate_rotation: narrow
    comment: Transfer plate with lid from bmg reader to specified tekmatic incubator

  - name: close incubator
    module: inheco_devID2_floor0
    action: close

  - name: close bmg
    module: bio_bmg
    action: close

  - name: run incubation
    module: inheco_devID2_floor0
    action: incubate
    args:
      temperature: 30.0
      shaker_frequency: 6.6
      wait_for_incubation_time: False
      incubation_time: payload.incubation_seconds
    comment: incubate for specified time

  - name: open incubator
    module: inheco_devID2_floor0
    action: open

  - name: transfer to exchange
    module: biopf400
    action: transfer
    args:
      source: payload.incubator_location
      target: exchange_deck_low_narrow
      source_approach: safe_path_inheco_dev2
      target_approach: safe_path_exchange
      source_plate_rotation: narrow
      target_plate_rotation: narrow
    comment: transfer microplate with lid to exchange

  - name: close incubator
    module: inheco_devID2_floor0
    action: close







